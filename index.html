<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temperature IoT</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            margin: 0;
            font-family: 'Tahoma', sans-serif;
            color: white;
            background-size: cover;
            background-position: center;
            background-image: url('https://images.unsplash.com/photo-1500530855697-b586d89ba3ee'); /* ‡∏†‡∏≤‡∏û‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô */
            transition: background-image 0.5s ease-in-out;
            min-height: 100vh;
        }

        .card {
            background: rgba(0, 0, 0, 0.65);
            max-width: 420px;
            margin: 20px auto;
            padding: 22px;
            border-radius: 22px;
            text-align: center;
            backdrop-filter: blur(5px);
        }

        .temp {
            font-size: 46px;
            font-weight: bold;
            margin: 10px 0;
        }

        /* ===== Tube (‡∏´‡∏•‡∏≠‡∏î‡∏ß‡∏±‡∏î‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥) ===== */
        #tube {
            width: 50px;
            height: 220px;
            margin: 15px auto;
            background: #111;
            border-radius: 30px;
            overflow: hidden;
            box-shadow: inset 0 0 12px #000;
            position: relative;
        }

        #fill {
            width: 100%;
            height: 0%; /* ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô */
            background: linear-gradient(180deg, #2ecc71, #f39c12, #e74c3c);
            transition: height 0.6s ease-out;
            position: absolute;
            bottom: 0;
            left: 0;
        }

        /* ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡∏ô‡πâ‡∏≥‡πÑ‡∏´‡∏• */
        #fill::after {
            content: "";
            position: absolute;
            top: 0;
            left: -80%;
            width: 80%;
            height: 100%;
            background: linear-gradient(120deg, rgba(255,255,255,0), rgba(255,255,255,0.4), rgba(255,255,255,0));
            animation: flow 2s linear infinite;
        }

        @keyframes flow {
            from { left: -80%; }
            to { left: 120%; }
        }

        /* ===== ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î ===== */
        button {
            padding: 12px 24px;
            margin: 6px;
            border: none;
            border-radius: 14px;
            font-size: 15px;
            color: white;
            cursor: pointer;
            transition: transform 0.1s;
        }
        button:active { transform: scale(0.95); }
        .on { background: #43a047; }
        .off { background: #e53935; }
        .on:hover { background: #2e7d32; }
        .off:hover { background: #c62828; }

        a { text-decoration: none; }

        /* ===== ‡∏ï‡∏≤‡∏£‡∏≤‡∏á ===== */
        table {
            width: 100%;
            margin-top: 10px;
            border-collapse: collapse;
            font-size: 13px;
        }
        th, td {
            border-bottom: 1px solid #555;
            padding: 8px;
        }
        th { color: #90caf9; }
    </style>
</head>

<body>
    <div class="card">
        <h2>üå° ‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏±‡∏î‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥</h2>
        <div style="color:#ddd; font-size:14px;">üìç ‡∏≠.‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏π‡∏£‡∏ì‡πå</div>
        <div id="status" style="margin-top:5px; font-weight:bold;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</div>

        <div class="temp" id="temp">-- ¬∞C</div>

        <div id="tube"><div id="fill"></div></div>

        <div style="background: rgba(255,255,255,0.1); border-radius:10px; padding:5px; margin-bottom:10px;">
            <canvas id="chart" height="140"></canvas>
        </div>
        
        <p id="time" style="font-size:12px; color:#aaa;">-</p>

        <button class="on" onclick="sendCommand('on')">‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö</button>
        <button class="off" onclick="sendCommand('off')">‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö</button>

        <h3>üìÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
        <table id="log">
            <thead>
                <tr><th>‡∏ß‡∏±‡∏ô-‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥</th></tr>
            </thead>
            <tbody id="logBody">
                <tr><td colspan="2">‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>
            </tbody>
        </table>
    </div>

    <script>
        // ============================================
        // ‚ö†Ô∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç IP Address ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö ESP8266 ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
        // ‡πÄ‡∏ä‡πà‡∏ô "http://192.168.1.45" (‡∏î‡∏π‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å Serial Monitor ‡∏ï‡∏≠‡∏ô‡∏ï‡πà‡∏≠ WiFi)
        const ESP_IP = "http://192.168.1.XXX"; 
        // ============================================

        let labels = [], temps = [];
        
        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏£‡∏≤‡∏ü
        const ctx = document.getElementById('chart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: '‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥',
                    data: temps,
                    borderColor: '#2196f3',
                    backgroundColor: 'rgba(33, 150, 243, 0.2)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { min: 0, max: 50, ticks: { color: '#ccc' } },
                    x: { ticks: { display: false } } // ‡∏ã‡πà‡∏≠‡∏ô‡πÅ‡∏Å‡∏ô X ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°
                },
                plugins: { legend: { display: false } }
            }
        });

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å ESP8266
        function loadData() {
            // ‡πÉ‡∏ä‡πâ URL ‡πÄ‡∏ï‡πá‡∏°‡πÜ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÑ‡∏ü‡∏•‡πå HTML ‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏ô‡∏•‡∏∞‡∏ó‡∏µ‡πà‡∏Å‡∏±‡∏ö‡∏ö‡∏≠‡∏£‡πå‡∏î
            fetch(ESP_IP + '/data')
                .then(response => response.json())
                .then(data => {
                    updateUI(data);
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('status').innerText = "‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ";
                    document.getElementById('status').style.color = "#ff5252";
                });
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
        function updateUI(d) {
            document.getElementById('temp').innerText = d.temp.toFixed(1) + " ¬∞C";
            document.getElementById('time').innerText = "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: " + d.time;
            
            const statusEl = document.getElementById('status');
            statusEl.innerText = d.on ? "üü¢ ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏õ‡∏¥‡∏î" : "üî¥ ‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏¥‡∏î";
            statusEl.style.color = d.on ? "#69f0ae" : "#ff5252";

            // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
            document.body.style.backgroundImage = d.on
                ? "url(https://images.unsplash.com/photo-1507525428034-b723cf961d3e)"
                : "url(https://images.unsplash.com/photo-1500530855697-b586d89ba3ee)";

            // ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ó‡πà‡∏á (‡∏´‡∏•‡∏≠‡∏î‡πÅ‡∏Å‡πâ‡∏ß)
            let fill = document.getElementById("fill");
            let h = Math.min(100, d.temp * 2); // ‡∏™‡∏°‡∏°‡∏ï‡∏¥ max 50c = 100%
            fill.style.height = h + "%";

            // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏´‡∏•‡∏≠‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πâ‡∏≠‡∏ô
            if (d.temp < 30) fill.style.background = "linear-gradient(180deg, #2ecc71, #27ae60)";
            else if (d.temp < 35) fill.style.background = "linear-gradient(180deg, #f1c40f, #e67e22)";
            else fill.style.background = "linear-gradient(180deg, #ff7043, #c0392b)";

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏™‡πâ‡∏ô
            if (labels.length > 10) { labels.shift(); temps.shift(); }
            labels.push(d.time.split(" ")[1]); // ‡πÄ‡∏≠‡∏≤‡πÅ‡∏Ñ‡πà‡πÄ‡∏ß‡∏•‡∏≤
            temps.push(d.temp);
            chart.update();

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á Log
            let tbody = document.getElementById("logBody");
            tbody.innerHTML = "";
            if(d.log && d.log.length > 0){
                d.log.forEach(r => {
                    tbody.innerHTML += `<tr><td>${r.time}</td><td>${r.temp.toFixed(1)}¬∞C</td></tr>`;
                });
            } else {
                tbody.innerHTML = `<tr><td colspan="2">- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -</td></tr>`;
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î
        function sendCommand(cmd) {
            // ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà ESP ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
            fetch(ESP_IP + '/' + cmd, { method: 'GET' }) // ‡∏´‡∏£‡∏∑‡∏≠ POST ‡∏ï‡∏≤‡∏°‡∏™‡∏∞‡∏î‡∏ß‡∏Å
                .then(() => {
                    console.log("Sent: " + cmd);
                    loadData(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏î
                })
                .catch(err => alert("‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err));
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏Å 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        setInterval(loadData, 3000);
        loadData(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    </script>
</body>
</html>
